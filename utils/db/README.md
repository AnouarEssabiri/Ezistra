# IndexedDB Database System - Enhanced Documentation\n\n## Overview\n\nThis is a comprehensive, production-ready IndexedDB system with:\n- ✅ **Type-safe** repository pattern\n- ✅ **DRY** base class for common CRUD operations\n- ✅ **Indexed queries** for faster searches\n- ✅ **Custom error handling** with specific error types\n- ✅ **Query/filter methods** for complex searches\n- ✅ **Migration system** for schema versioning\n- ✅ **Centralized service** for repository management\n\n## File Structure\n\n```\nutils/db/\n├── index.table.ts          # Core DB initialization with schema & indexes\n├── base.repository.ts      # Abstract base class for all repositories\n├── errors.ts              # Custom error types\n├── migrations.ts          # Schema migrations & versioning\n├── index.ts              # Central exports & DatabaseService\n├── users.table.ts        # Users repository (extends BaseRepository)\n├── documents.table.ts    # Documents repository\n├── address_info.table.ts # Address repository\n├── university_info.table.ts # University repository\n├── higher_education.table.ts # Higher education repository\n├── complementary_info.table.ts # Complementary info repository\n├── baccalaureat_info.table.ts # Baccalaureate repository\n└── personal_info.table.ts # Personal info repository\n```\n\n## Quick Start\n\n### Using the DatabaseService\n\n```typescript\nimport DatabaseService from \"@/utils/db\";\n\n// Get repository instances\nconst repos = DatabaseService.getAllRepositories();\n\n// Use repositories\nconst users = await repos.users.getAll();\nconst user = await repos.users.getById(\"123\");\n```\n\n### Using Individual Repositories\n\n```typescript\nimport { Users, Documents } from \"@/utils/db\";\n\nconst usersRepo = new Users();\nconst documentsRepo = new Documents();\n\n// CRUD operations\nconst userId = await usersRepo.add({ /* data */ });\nconst user = await usersRepo.getById(userId);\nawait usersRepo.update(userId, { /* updates */ });\nawait usersRepo.delete(userId);\n```\n\n## Core Features\n\n### 1. Base Repository Methods\n\nAll repositories inherit these methods from `BaseRepository<T>`:\n\n#### CRUD Operations\n```typescript\n// Create\nawait repo.add(data: T): Promise<string | number | undefined>\nawait repo.addMany(data: T[]): Promise<(string | number | undefined)[]>\n\n// Read\nawait repo.getAll(): Promise<T[]>\nawait repo.getById(id): Promise<T | undefined>\nawait repo.findByIndex(indexName, value): Promise<T[]>\nawait repo.filter(predicate): Promise<T[]>\nawait repo.findOne(predicate): Promise<T | undefined>\n\n// Update\nawait repo.update(id, updates): Promise<boolean>\n\n// Delete\nawait repo.delete(id): Promise<boolean>\nawait repo.deleteMany(ids): Promise<number>\n\n// Utility\nawait repo.count(): Promise<number>\nawait repo.clear(): Promise<boolean>\n```\n\n### 2. Indexed Queries\n\nEach store has pre-defined indexes for fast lookups:\n\n**Users Store:**\n- `cne` - CNE identity number\n- `cin` - CIN card number\n- `email` - Email address\n\n**Documents Store:**\n- `studentId` - Student reference\n- `type` - Document type\n\n**University Store:**\n- `studentId` - Student reference\n- `academicYear` - Academic year\n\n**Higher Education Store:**\n- `studentId` - Student reference\n- `level` - Education level (bac+2, bac+3, bac+5)\n\n**Complementary Store:**\n- `studentId` - Student reference\n- `studentStatus` - Status (inscrit, ancien étudiant, etc.)\n\n**Address Store:**\n- `studentId` - Student reference\n- `type` - Address type (student, parent)\n- `email` - Email address\n\n**Baccalaureate Store:**\n- `studentId` - Student reference\n- `year` - Year of exam\n\n**Personal Info Store:**\n- `cne` - CNE identity number\n- `cin` - CIN card number\n\n### 3. Repository-Specific Methods\n\nEach repository extends BaseRepository with domain-specific queries:\n\n#### Users\n```typescript\nawait users.findByCNE(cne: string)\nawait users.findByCIN(cin: string)\nawait users.findByEmail(email: string)\nawait users.searchByName(name: string) // Searches Arabic & French names\nawait users.findByGender(gender: \"M\" | \"F\")\nawait users.findWithHandicap()\n```\n\n#### Documents\n```typescript\nawait documents.getByStudentId(studentId: string)\nawait documents.getByType(type: string)\nawait documents.getByStudentIdAndType(studentId, type)\nawait documents.searchByFileName(fileName: string)\n```\n\n#### Address\n```typescript\nawait address.getByStudentId(studentId: string)\nawait address.getStudentAddresses(studentId: string)\nawait address.getParentAddresses(studentId: string)\nawait address.findByEmail(email: string)\n```\n\n#### University\n```typescript\nawait university.getByStudentId(studentId: string)\nawait university.getByAcademicYear(academicYear: string)\nawait university.getCurrentYearInfo(studentId: string)\n```\n\n#### HigherEducation\n```typescript\nawait higherEducation.getByStudentId(studentId: string)\nawait higherEducation.getByLevel(level: string) // bac+2, bac+3, bac+5\nawait higherEducation.getByStudentIdAndLevel(studentId, level)\n```\n\n#### Complementary\n```typescript\nawait complementary.getByStudentId(studentId: string)\nawait complementary.getByStatus(status: string)\nawait complementary.getActiveStudents()\nawait complementary.getAlumni()\n```\n\n#### Baccalaureat\n```typescript\nawait baccalaureat.getByStudentId(studentId: string)\nawait baccalaureat.getByYear(year: string)\nawait baccalaureat.getByType(bacType: string)\nawait baccalaureat.getHighPerformers() // grade >= 16\n```\n\n#### PersonalInfo\n```typescript\nawait personalInfo.findByCNE(cne: string)\nawait personalInfo.findByCIN(cin: string)\nawait personalInfo.searchByName(name: string)\n```\n\n### 4. Error Handling\n\n```typescript\nimport { DatabaseError, NotFoundError, ValidationError, OperationError } from \"@/utils/db\";\n\ntry {\n  await users.update(\"invalid-id\", { name: \"John\" });\n} catch (error) {\n  if (error instanceof NotFoundError) {\n    console.log(\"Record not found\");\n  } else if (error instanceof ValidationError) {\n    console.log(\"Invalid data\");\n  } else if (error instanceof OperationError) {\n    console.log(\"Database operation failed\");\n  }\n}\n```\n\n### 5. Batch Operations\n\n```typescript\n// Batch add\nconst ids = await users.addMany([\n  { /* user1 */ },\n  { /* user2 */ },\n  { /* user3 */ },\n]);\n\n// Batch delete\nconst deletedCount = await users.deleteMany([id1, id2, id3]);\n```\n\n### 6. Migrations\n\nAdd new migrations in `migrations.ts`:\n\n```typescript\nexport const migrations: Migration[] = [\n  {\n    version: 1,\n    description: \"Initial schema\",\n    upgrade: async (db) => { /* ... */ },\n  },\n  {\n    version: 2,\n    description: \"Add new store\",\n    upgrade: async (db) => {\n      // Add new store or indexes\n    },\n  },\n];\n```\n\n## Examples\n\n### Example 1: Find a student by CNE\n\n```typescript\nconst usersRepo = new Users();\nconst student = await usersRepo.findByCNE(\"AB123456\");\nif (student) {\n  console.log(`Found: ${student.firstName} ${student.lastName}`);\n}\n```\n\n### Example 2: Get all documents for a student\n\n```typescript\nconst docsRepo = new Documents();\nconst documents = await docsRepo.getByStudentId(\"student-123\");\ndocuments.forEach(doc => {\n  console.log(`${doc.type}: ${doc.fileName}`);\n});\n```\n\n### Example 3: Find high performers\n\n```typescript\nconst bacRepo = new Baccalaureat();\nconst topStudents = await bacRepo.getHighPerformers();\nconsole.log(`${topStudents.length} students scored >= 16`);\n```\n\n### Example 4: Search students by name\n\n```typescript\nconst usersRepo = new Users();\nconst results = await usersRepo.searchByName(\"Mohammed\");\nconsole.log(`Found ${results.length} students`);\n```\n\n### Example 5: Get current year info\n\n```typescript\nconst univRepo = new University();\nconst currentYear = await univRepo.getCurrentYearInfo(\"student-123\");\nif (currentYear) {\n  console.log(`${currentYear.filiere} - ${currentYear.academicYear}`);\n}\n```\n\n## Performance Considerations\n\n1. **Indexes**: Queries using indexed fields are significantly faster\n2. **Filter vs findByIndex**: Use `findByIndex()` for indexed fields, `filter()` for custom predicates\n3. **Batch operations**: Use `addMany()` and `deleteMany()` for bulk operations\n4. **Count before delete**: Check `count()` before deletion to avoid unnecessary operations\n\n## Best Practices\n\n1. **Always use type-safe queries**: Prefer `findByCNE()` over generic filters when possible\n2. **Handle errors properly**: Catch specific error types\n3. **Use DatabaseService for consistency**: Central management of repositories\n4. **Validate input data**: Use try-catch with ValidationError\n5. **Keep migrations clean**: Update migrations.ts for schema changes\n\n## Migration Example\n\nTo add a new index:\n\n```typescript\n// 1. Update index.table.ts storeDefinitions\n{\n  name: \"users\",\n  options: { keyPath: \"id\", autoIncrement: true },\n  indexes: [\n    { name: \"cne\", keyPath: \"cne\" },\n    { name: \"phone\", keyPath: \"phone\" }, // NEW\n  ]\n}\n\n// 2. Add migration in migrations.ts\n{\n  version: 2,\n  description: \"Add phone index to users\",\n  upgrade: async (db) => {\n    const store = db.transaction(\"users\", \"readonly\").store;\n    store.createIndex(\"phone\", \"phone\");\n  },\n}\n```\n\n## Browser Compatibility\n\n- Chrome/Edge: Full support\n- Firefox: Full support\n- Safari: Full support (11+)\n- IE: Not supported (use polyfill if needed)\n\n## API Reference\n\nSee inline JSDoc comments in each file for detailed method signatures and return types.\n