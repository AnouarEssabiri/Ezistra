# Frontend Database Implementation Guide\n\n## Project Overview\n\nThis is a **Next.js 15 + React 19** frontend project (full-stack with backend in `/backend`)\n\n### Key Dependencies\n- React 19\n- Next.js 15.2.4\n- TypeScript 5\n- Radix UI components\n- React Hook Form + Zod validation\n- `idb` (already installed v8.0.3) ✅\n\n## ✅ Good News\n\n1. **`idb` library is already installed** - Your IndexedDB wrapper is ready to use\n2. **React 19 supports client-side storage** - Perfect for frontend database\n3. **TypeScript is configured** - Full type safety available\n4. **Database system is production-ready** - All enhancements completed\n\n## Project Issues Found\n\n### Frontend Issues (Can be fixed)\n\n| Issue | File | Severity | Fix |\n|-------|------|----------|-----|\n| Missing `useIsMobile` hook | `components/ui/sidebar.tsx` | Low | Export `useIsMobile` or rename to `useMobile` |\n| Missing `Input` component | `components/profile-settings/NotificationSection.tsx` | Medium | Import or create Input component |\n| Type errors in FormFillingSection | `app/profile-settings/components/FormFillingSection.tsx` | Medium | Fix Switch component props/state typing |\n| Implicit `any` types | Various files | Low | Add explicit types to parameters |\n\n### Backend Issues (Separate from frontend)\n\n- Missing NestJS dependencies (separate backend project)\n- Test configuration incomplete\n- Not needed for frontend database work\n\n**Status:** Frontend is usable, backend needs separate fixes\n\n## How to Use Database on Frontend\n\n### 1. Create a Client-Side Hook\n\n```typescript\n// hooks/useDatabase.ts\nimport { useEffect, useState } from 'react';\nimport DatabaseService from '@/utils/db';\n\nexport function useDatabase() {\n  const [isReady, setIsReady] = useState(false);\n  const repos = DatabaseService.getAllRepositories();\n\n  useEffect(() => {\n    // Database is ready when component mounts\n    setIsReady(true);\n  }, []);\n\n  return { repos, isReady };\n}\n```\n\n### 2. Use in Components\n\n```typescript\n// app/profile-settings/page.tsx\n'use client';\n\nimport { useDatabase } from '@/hooks/useDatabase';\nimport { useState } from 'react';\n\nexport default function ProfilePage() {\n  const { repos, isReady } = useDatabase();\n  const [profile, setProfile] = useState(null);\n\n  async function saveProfile(data) {\n    if (!isReady) return;\n    \n    try {\n      const id = await repos.users.add(data);\n      console.log('Profile saved with ID:', id);\n    } catch (error) {\n      console.error('Failed to save profile:', error);\n    }\n  }\n\n  return (\n    <div>\n      {/* Your form UI */}\n    </div>\n  );\n}\n```\n\n### 3. Real Example: Student Profile Form\n\n```typescript\n'use client';\n\nimport { useDatabase } from '@/hooks/useDatabase';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\n\nconst profileSchema = z.object({\n  firstName: z.string().min(1),\n  lastName: z.string().min(1),\n  cne: z.string(),\n  cin: z.string(),\n  email: z.string().email(),\n});\n\nexport function StudentProfileForm() {\n  const { repos, isReady } = useDatabase();\n  const { register, handleSubmit, formState: { errors } } = useForm({\n    resolver: zodResolver(profileSchema),\n  });\n\n  const onSubmit = async (data) => {\n    if (!isReady) return;\n    \n    try {\n      const id = await repos.users.add(data);\n      console.log('Saved:', id);\n      // Show success message\n    } catch (error) {\n      console.error('Error:', error);\n    }\n  };\n\n  return (\n    <form onSubmit={handleSubmit(onSubmit)}>\n      <input {...register('firstName')} />\n      <input {...register('lastName')} />\n      <input {...register('cne')} />\n      <input {...register('cin')} />\n      <input {...register('email')} type=\"email\" />\n      <button type=\"submit\">Save Profile</button>\n    </form>\n  );\n}\n```\n\n## Available Database Operations\n\n### Query Examples\n\n```typescript\nconst { repos } = useDatabase();\n\n// Find student by CNE (FAST - indexed)\nconst student = await repos.users.findByCNE('AB123456');\n\n// Search by name\nconst results = await repos.users.searchByName('Mohammed');\n\n// Get all documents for a student\nconst docs = await repos.documents.getByStudentId('student-123');\n\n// Get high performers\nconst topStudents = await repos.baccalaureat.getHighPerformers();\n\n// Get current academic year info\nconst current = await repos.university.getCurrentYearInfo('student-123');\n\n// Count total records\nconst total = await repos.users.count();\n\n// Batch operations\nconst ids = await repos.users.addMany([user1, user2, user3]);\nconst deleted = await repos.users.deleteMany([id1, id2]);\n```\n\n## Error Handling\n\n```typescript\nimport { NotFoundError, ValidationError, OperationError } from '@/utils/db';\n\ntry {\n  await repos.users.update(userId, updates);\n} catch (error) {\n  if (error instanceof NotFoundError) {\n    console.log('User not found');\n  } else if (error instanceof ValidationError) {\n    console.log('Invalid data:', error.message);\n  } else if (error instanceof OperationError) {\n    console.log('Database error:', error.message);\n  }\n}\n```\n\n## Data Models (from lib/types.ts)\n\nAll databases use these TypeScript interfaces:\n\n### PersonalInfo\n```typescript\nid: string\ncne: string\ncin: string\nfirstName: string\nlastName: string\nfirstNameAr: string\nlastNameAr: string\nbirthDate: string // yyyy-mm-dd\nbirthPlace: string\ngender: \"M\" | \"F\"\nnatinality: string\ncivilStatus: string\nhandicap: boolean\nhandicapType?: string\n```\n\n### DocumentInfo\n```typescript\nid: string\nstudentId: string\ntype: string\nfileName: string\nfileSize: number\nfileType: string\nfileContent: Blob | string\n```\n\n### AddressInfo\n```typescript\nid: string\nstudentId: string\ntype: \"student\" | \"parent\"\naddress: string\npostalCode: string\ncommune: string\nprovince: string\nemail1?: string\nemail2?: string\nphone: string\n```\n\n### UniversityInfo\n```typescript\nid: string\nstudentId: string\nacademicYear: string\nfiliere: string\n```\n\n### HigherEducationInfo\n```typescript\nid: string\nstudentId: string\nlevel: \"bac+2\" | \"bac+3\" | \"bac+5\"\nyear: string\ngrades?: { s1?: number, s2?: number, ... s10?: number }\ndiplomGrade?: number\nmention?: string\nfiliere: string\ndiplomatType: string\ninstitution: string\n```\n\n### ComplementaryInfo\n```typescript\nid: string\nstudentId: string\nhigherEduDate?: string\nuniversityDate?: string\ninstitutionDate: string\nstudentStatus: string\nprofession?: string\nemployer?: string\n```\n\n### BaccalaureatInfo\n```typescript\nid: string\nstudentId: string\nyear: string\ngrade: number\nbacType: string\ninstitution: string\nserie: string\nmention: string\nacademy: string\nprovince: string\n```\n\n## Browser Storage Location\n\nIndexedDB data is stored in:\n- **Chrome/Edge:** `%APPDATA%/Google/Chrome/Default/IndexedDB` (or `/Edge/Default/`)\n- **Firefox:** `~/.mozilla/firefox/<profile>/storage/default`\n- **Safari:** `~/Library/Safari/LocalStorage`\n\nDatabase name: `ezistraDB`\n\n## Testing Database\n\n### In Browser Console\n```javascript\n// Open DevTools → Application → IndexedDB → ezistraDB\n// You'll see all 9 stores with their data\n```\n\n### In Component\n```typescript\nimport { DB } from '@/utils/db';\n\nasync function testDB() {\n  const db = await DB();\n  console.log('Database initialized:', db.name);\n  console.log('Stores:', Array.from(db.objectStoreNames));\n}\n```\n\n## Performance Tips\n\n1. **Memoize database operations**\n   ```typescript\n   const [users, setUsers] = useState([]);\n   \n   useEffect(() => {\n     repos.users.getAll().then(setUsers);\n   }, []);\n   ```\n\n2. **Use indexed queries**\n   - ✅ `findByCNE()` - indexed, fast\n   - ❌ `filter(u => u.cne === '...')` - slow scan\n\n3. **Cache frequently accessed data**\n   ```typescript\n   const [cached, setCached] = useState<Map<string, any>>(new Map());\n   ```\n\n4. **Batch operations for bulk inserts**\n   - Use `addMany()` instead of looping `add()`\n\n## Common Use Cases\n\n### 1. Form with Auto-Save\n```typescript\nconst handleChange = debounce(async (data) => {\n  await repos.users.update(userId, data);\n}, 1000);\n```\n\n### 2. Search Form\n```typescript\nconst [query, setQuery] = useState('');\nconst [results, setResults] = useState([]);\n\nconst handleSearch = async (searchTerm: string) => {\n  const found = await repos.users.searchByName(searchTerm);\n  setResults(found);\n};\n```\n\n### 3. Multi-Step Form\n```typescript\n// Step 1: Save personal info\nconst userId = await repos.users.add(step1Data);\n\n// Step 2: Save address with userId reference\nawait repos.address.add({ ...step2Data, studentId: userId });\n\n// Step 3: Save documents\nawait repos.documents.addMany(docs.map(d => ({\n  ...d,\n  studentId: userId\n})));\n```\n\n## Next Steps to Implement\n\n1. **Create hook** (`hooks/useDatabase.ts`)\n2. **Fix frontend issues** (See Quick Fix Guide below)\n3. **Add database to forms** (Start with one component)\n4. **Test in DevTools** (View IndexedDB data)\n5. **Add error handling** (Toast notifications)\n6. **Implement offline support** (Already works with IndexedDB)\n\n## Quick Fix Guide for Frontend Issues\n\n### Issue 1: useIsMobile Hook\n```typescript\n// components/ui/sidebar.tsx - Change line 8\n- import { useIsMobile } from \"@/hooks/use-mobile\"\n+ import { useMobile } from \"@/hooks/use-mobile\"\n// Then update all usages:\n- const isMobile = useIsMobile()\n+ const isMobile = useMobile()\n```\n\n### Issue 2: Missing Input Component\n```typescript\n// components/profile-settings/NotificationSection.tsx\n// Add import at top:\nimport { Input } from \"@/components/ui/input\"\n// Make sure it exists in components/ui/input.tsx\n```\n\n### Issue 3: Switch Component Props\n```typescript\n// Fix Switch component to match Radix UI API\n<Switch \n  checked={value}\n  onCheckedChange={handleChange}\n/>\n// Remove: size=\"sm\" (not a valid prop)\n```\n\n## Browser Support\n\n| Browser | IndexedDB | Status |\n|---------|-----------|--------|\n| Chrome | ✅ | Fully supported |\n| Firefox | ✅ | Fully supported |\n| Safari | ✅ | Supported (11+) |\n| Edge | ✅ | Fully supported |\n| IE | ❌ | Not supported |\n\n## Debugging\n\n### View IndexedDB Data\n1. Open DevTools (F12)\n2. Go to Application tab\n3. IndexedDB → ezistraDB\n4. Browse stores and records\n\n### Check for Errors\n```typescript\ntry {\n  await operation()\n} catch (error) {\n  console.error('Code:', error.code)\n  console.error('Message:', error.message)\n  console.error('Stack:', error.stack)\n}\n```\n\n## API Reference\n\n### Users Repository\n- `add(data)` - Add user\n- `getAll()` - Get all users\n- `getById(id)` - Get by ID\n- `findByCNE(cne)` - Find by CNE (indexed)\n- `findByCIN(cin)` - Find by CIN (indexed)\n- `findByEmail(email)` - Find by email (indexed)\n- `searchByName(name)` - Search by name (Arabic/French)\n- `findByGender(gender)` - Filter by gender\n- `findWithHandicap()` - Students with handicap\n- `update(id, updates)` - Update user\n- `delete(id)` - Delete user\n- `count()` - Count total\n- `clear()` - Clear all\n\n(Similar methods available for all 8 other repositories)\n\n## Production Checklist\n\n- [ ] Create `hooks/useDatabase.ts`\n- [ ] Fix 3 frontend issues (see Quick Fix Guide)\n- [ ] Test with one form component\n- [ ] Add error handling with toast notifications\n- [ ] Test offline functionality\n- [ ] Test in production build (`npm run build`)\n- [ ] Monitor IndexedDB performance\n- [ ] Add data backup/export functionality\n\n## Questions?\n\nRefer to `utils/db/README.md` and `utils/db/QUICK_REFERENCE.md` for complete API documentation.\n